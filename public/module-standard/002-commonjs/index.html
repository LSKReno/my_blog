<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>002-理解CommonJS | Half Town前端周刊</title>
    <meta name="description" content="白糖炒栗子哒前端Blog">
    <link rel="icon" href="/favicon.ico">
  <link rel="mainfest" href="/mainfest.json">
    
    <link rel="preload" href="/assets/css/0.styles.d4c32f31.css" as="style"><link rel="preload" href="/assets/js/app.b1906b97.js" as="script"><link rel="preload" href="/assets/js/2.bdee5faf.js" as="script"><link rel="preload" href="/assets/js/18.ade73665.js" as="script"><link rel="preload" href="/assets/js/7.f0379e88.js" as="script"><link rel="preload" href="/assets/js/8.e132ed9d.js" as="script"><link rel="prefetch" href="/assets/js/10.e085a21c.js"><link rel="prefetch" href="/assets/js/100.78a0b04f.js"><link rel="prefetch" href="/assets/js/101.02ef3e98.js"><link rel="prefetch" href="/assets/js/102.cdd542e1.js"><link rel="prefetch" href="/assets/js/103.de748a03.js"><link rel="prefetch" href="/assets/js/104.7455cba5.js"><link rel="prefetch" href="/assets/js/105.68a805c9.js"><link rel="prefetch" href="/assets/js/106.a2ff7e85.js"><link rel="prefetch" href="/assets/js/107.36f34ab6.js"><link rel="prefetch" href="/assets/js/108.f26732f6.js"><link rel="prefetch" href="/assets/js/109.8d05e086.js"><link rel="prefetch" href="/assets/js/11.f2fd41dc.js"><link rel="prefetch" href="/assets/js/110.c7f84bd1.js"><link rel="prefetch" href="/assets/js/111.0cdf0d73.js"><link rel="prefetch" href="/assets/js/12.450e705b.js"><link rel="prefetch" href="/assets/js/13.50973e7a.js"><link rel="prefetch" href="/assets/js/14.40fad099.js"><link rel="prefetch" href="/assets/js/15.a2d432ad.js"><link rel="prefetch" href="/assets/js/16.4ad6c82f.js"><link rel="prefetch" href="/assets/js/17.1bc86885.js"><link rel="prefetch" href="/assets/js/19.a0f47a6e.js"><link rel="prefetch" href="/assets/js/20.5499b902.js"><link rel="prefetch" href="/assets/js/21.86afe090.js"><link rel="prefetch" href="/assets/js/22.29fa6f17.js"><link rel="prefetch" href="/assets/js/23.1af6f734.js"><link rel="prefetch" href="/assets/js/24.933ea1dd.js"><link rel="prefetch" href="/assets/js/25.7b5dc5f0.js"><link rel="prefetch" href="/assets/js/26.03194069.js"><link rel="prefetch" href="/assets/js/27.eb1fac5c.js"><link rel="prefetch" href="/assets/js/28.01df134d.js"><link rel="prefetch" href="/assets/js/29.697d4c02.js"><link rel="prefetch" href="/assets/js/3.77f61fb0.js"><link rel="prefetch" href="/assets/js/30.e1b58026.js"><link rel="prefetch" href="/assets/js/31.41db2b44.js"><link rel="prefetch" href="/assets/js/32.9f2db749.js"><link rel="prefetch" href="/assets/js/33.03b6d68a.js"><link rel="prefetch" href="/assets/js/34.09609909.js"><link rel="prefetch" href="/assets/js/35.c80be0ac.js"><link rel="prefetch" href="/assets/js/36.d15e6050.js"><link rel="prefetch" href="/assets/js/37.1ccd8184.js"><link rel="prefetch" href="/assets/js/38.ab0d4b98.js"><link rel="prefetch" href="/assets/js/39.8301eaad.js"><link rel="prefetch" href="/assets/js/4.90b687b0.js"><link rel="prefetch" href="/assets/js/40.d95907af.js"><link rel="prefetch" href="/assets/js/41.33845e14.js"><link rel="prefetch" href="/assets/js/42.8a256266.js"><link rel="prefetch" href="/assets/js/43.343b309f.js"><link rel="prefetch" href="/assets/js/44.e61b9da2.js"><link rel="prefetch" href="/assets/js/45.0eea8be7.js"><link rel="prefetch" href="/assets/js/46.861203d9.js"><link rel="prefetch" href="/assets/js/47.ae5bd907.js"><link rel="prefetch" href="/assets/js/48.1dbfd265.js"><link rel="prefetch" href="/assets/js/49.87f2ea7e.js"><link rel="prefetch" href="/assets/js/5.06355c1f.js"><link rel="prefetch" href="/assets/js/50.92bcf9cd.js"><link rel="prefetch" href="/assets/js/51.2b54e26b.js"><link rel="prefetch" href="/assets/js/52.ef61db16.js"><link rel="prefetch" href="/assets/js/53.e8411588.js"><link rel="prefetch" href="/assets/js/54.6f0a7cd7.js"><link rel="prefetch" href="/assets/js/55.40d0a721.js"><link rel="prefetch" href="/assets/js/56.76ff8ce6.js"><link rel="prefetch" href="/assets/js/57.cfea78e2.js"><link rel="prefetch" href="/assets/js/58.f8c35f3d.js"><link rel="prefetch" href="/assets/js/59.02cbb18a.js"><link rel="prefetch" href="/assets/js/6.d108277e.js"><link rel="prefetch" href="/assets/js/60.2df7b32b.js"><link rel="prefetch" href="/assets/js/61.16805fc4.js"><link rel="prefetch" href="/assets/js/62.ef5ca102.js"><link rel="prefetch" href="/assets/js/63.923718a5.js"><link rel="prefetch" href="/assets/js/64.d40092dd.js"><link rel="prefetch" href="/assets/js/65.d68a358c.js"><link rel="prefetch" href="/assets/js/66.b4323cbe.js"><link rel="prefetch" href="/assets/js/67.3a9004c1.js"><link rel="prefetch" href="/assets/js/68.350f6fbb.js"><link rel="prefetch" href="/assets/js/69.fdebae43.js"><link rel="prefetch" href="/assets/js/70.ccac64ba.js"><link rel="prefetch" href="/assets/js/71.8948f6c8.js"><link rel="prefetch" href="/assets/js/72.f5d07472.js"><link rel="prefetch" href="/assets/js/73.c2ddba1b.js"><link rel="prefetch" href="/assets/js/74.7a96d852.js"><link rel="prefetch" href="/assets/js/75.d452b4b5.js"><link rel="prefetch" href="/assets/js/76.5eac82cb.js"><link rel="prefetch" href="/assets/js/77.49a8f94c.js"><link rel="prefetch" href="/assets/js/78.17478c01.js"><link rel="prefetch" href="/assets/js/79.545a2920.js"><link rel="prefetch" href="/assets/js/80.172aeb42.js"><link rel="prefetch" href="/assets/js/81.6376c78a.js"><link rel="prefetch" href="/assets/js/82.1dfa8f89.js"><link rel="prefetch" href="/assets/js/83.fc10680d.js"><link rel="prefetch" href="/assets/js/84.41df0212.js"><link rel="prefetch" href="/assets/js/85.b57d2894.js"><link rel="prefetch" href="/assets/js/86.1bed09b1.js"><link rel="prefetch" href="/assets/js/87.3bc2e0cf.js"><link rel="prefetch" href="/assets/js/88.5797d5a1.js"><link rel="prefetch" href="/assets/js/89.cfc4d086.js"><link rel="prefetch" href="/assets/js/9.17617c7c.js"><link rel="prefetch" href="/assets/js/90.d3796c5b.js"><link rel="prefetch" href="/assets/js/91.f9e0f122.js"><link rel="prefetch" href="/assets/js/92.8ce6ae6a.js"><link rel="prefetch" href="/assets/js/93.f1c144ce.js"><link rel="prefetch" href="/assets/js/94.1877adf1.js"><link rel="prefetch" href="/assets/js/95.41ce2c18.js"><link rel="prefetch" href="/assets/js/96.07be3e30.js"><link rel="prefetch" href="/assets/js/97.d6ecd209.js"><link rel="prefetch" href="/assets/js/98.b1431a2d.js"><link rel="prefetch" href="/assets/js/99.acea4094.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d4c32f31.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Half Town前端周刊</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/posts/" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/LSKReno" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://weibo.com/u/5092674629" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://lskreno.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LSKReno的 博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/posts/" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/LSKReno" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://weibo.com/u/5092674629" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://lskreno.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LSKReno的 博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/posts/" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结前端技术文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6-11新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入JavaScript系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Browser浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS-API揭秘系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>搞懂那个TCP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>这个面试不太难</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写JS系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue大赏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Koa大赏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB大赏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端模块化规范</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/module-standard/001-module-concept/" class="sidebar-link">001-前端模块化</a></li><li><a href="/module-standard/002-commonjs/" class="active sidebar-link">002-理解CommonJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#一、什么是commonjs" class="sidebar-link">一、什么是CommonJS</a></li><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#二、commonjs的作用" class="sidebar-link">二、CommonJS的作用</a></li><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#三、nodejs中commonjs的实现" class="sidebar-link">三、NodeJS中CommonJS的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#_1-模块的导入导出的应用栗子" class="sidebar-link">1. 模块的导入导出的应用栗子</a></li><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#_2-模块加载源码理解" class="sidebar-link">2. 模块加载源码理解</a></li><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#_3-解惑" class="sidebar-link">3. 解惑</a></li></ul></li><li class="sidebar-sub-header"><a href="/module-standard/002-commonjs/#thank" class="sidebar-link">THANK</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端自动化测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue-cli的配置详解</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>关于</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_002-理解commonjs"><a href="#_002-理解commonjs" aria-hidden="true" class="header-anchor">#</a> 002-理解CommonJS</h1> <p><div data-v-21553e4a><p data-v-21553e4a><strong data-v-21553e4a>Hey mate, Please know that</strong></p> <div data-v-21553e4a>坚持比努力更可怕</div> <div class="seperator" data-v-21553e4a></div></div></p> <p><img src="/assets/img/commonjs.18d89ef4.png" alt=""></p> <h2 id="一、什么是commonjs"><a href="#一、什么是commonjs" aria-hidden="true" class="header-anchor">#</a> 一、什么是CommonJS</h2> <p>CommonJS是一种规范，我们关心的是它的模块化规范。</p> <p>该规范的目标是使JavaScript能够不仅在浏览器中运行，并且可以在Web服务器，桌面和命令行应用程序中建立JavaScript生态系统（原来的JS只能够构建基于浏览器的应用程序）。</p> <p>该规范对模块的定义有：</p> <ol><li><p>模块的定义</p></li> <li><p>模块的引用</p></li> <li><p>模块的标识</p></li></ol> <p>也就是<code>module</code>, <code>exports</code>, <code>require</code></p> <p>模块必须通过 <code>module.exports</code> 导出对外的变量或接口，通过 <code>require()</code> 来导入其他模块的导出到当前模块的作用域中。</p> <p>CommonJS 不参与具体的代码实现，它就像是大家自觉选择遵守的规则一样，具体的实现最火的有Nodejs。</p> <h2 id="二、commonjs的作用"><a href="#二、commonjs的作用" aria-hidden="true" class="header-anchor">#</a> 二、CommonJS的作用</h2> <p>CommonJS 规范出现的原因就是由于JavaScript语言本身并没有一种模块机制来保证不同模块可以使用相同的变量名，难以做到模块化和包管理，所以JS很难作为后端语言来进行大型项目的开发(当然ES6已经有了模块化规范:<code>export</code>, <code>import</code>, <code>export default</code>)。</p> <p>所以为了解决 JavaScript 的作用域问题，需要定义一种模块化形式，可以使每个模块在它自身的命名空间中执行。这就是CommonJS的作用。</p> <h2 id="三、nodejs中commonjs的实现"><a href="#三、nodejs中commonjs的实现" aria-hidden="true" class="header-anchor">#</a> 三、NodeJS中CommonJS的实现</h2> <p>下面主要来理解下我们的Node中的CommonJS的导入模块的实现，<a href="https://github.com/nodejs/node/blob/b04de23afa6da18d7b81b70c1a4bb53476f125c7/lib/internal/modules/cjs/loader.js" target="_blank" rel="noopener noreferrer">Module源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="_1-模块的导入导出的应用栗子"><a href="#_1-模块的导入导出的应用栗子" aria-hidden="true" class="header-anchor">#</a> 1. 模块的导入导出的应用栗子</h3> <h4 id="导出"><a href="#导出" aria-hidden="true" class="header-anchor">#</a> 导出</h4> <p>导出在node中有两种方式：</p> <ol><li>将需要导出的变量或函数挂载到 exports 对象上</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token string">'foo'</span>
<span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token string">'bar'</span>
exports<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'foo'</span>
exports<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token string">'bar'</span>
<span class="token comment">// 但是你不可以直接对exports赋值：下面的代码虽然可以执行，但是模块并不会导出foo和bar。</span>
<span class="token comment">// 在后面会详细解释</span>
exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    foo<span class="token punctuation">:</span> foo<span class="token punctuation">,</span>
    bar<span class="token punctuation">:</span> bar
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>使用 <code>module.exports</code> 对象整体导出一个变量对象或者函数</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span>
<span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token string">&quot;bar&quot;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    foo<span class="token punctuation">,</span> 
    bar
<span class="token punctuation">}</span>
<span class="token comment">//或者函数的导出</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="导入"><a href="#导入" aria-hidden="true" class="header-anchor">#</a> 导入</h4> <p>下面有三种来源不同的包引入，主要差异在于路径上的差异(自己编写的模块需要加上相对路径)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Node核心模块的引入 </span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token comment">// 第三方，npm上用户发布的模块</span>
<span class="token keyword">let</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 用户自己编写的模块引入</span>
<span class="token keyword">let</span> fooModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./foo.js'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-模块加载源码理解"><a href="#_2-模块加载源码理解" aria-hidden="true" class="header-anchor">#</a> 2. 模块加载源码理解</h3> <p>上面我们说到在Node中使用导出的时候有使用到<code>exports</code>但是却不可以直接对其进行赋值，而应该将其当作一个对象，给里面的属性进行赋值。</p> <p>下面我们来简单分析理解一下Node的加载机制，<a href="https://github.com/nodejs/node/blob/b04de23afa6da18d7b81b70c1a4bb53476f125c7/lib/internal/modules/cjs/loader.js" target="_blank" rel="noopener noreferrer">Modules源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>Nodejs并没有定义额外的语法来实现模块化，我们知道Node.js 每一个文件都是一个模块。Node内置了一些对象和方法来实现模块化。</p> <p><img src="https://lskreno-typora.oss-cn-beijing.aliyuncs.com/img/NodeModuleSrc.png" alt=""></p> <h4 id="_1-module对象"><a href="#_1-module对象" aria-hidden="true" class="header-anchor">#</a> (1)Module对象</h4> <p>Node在每个模块中都内置了一个module对象来表示自身模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// foo.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-text"><code>&gt; node foo.js
Module {
  id: '.',
  exports: {},
  parent: null,
  filename: 'C:\\Users\\DELL\\Desktop\\module-learn\\foo.js',
  loaded: false,
  children: [],
  paths:
   [ 'C:\\Users\\DELL\\Desktop\\module-learn\\node_modules',
     'C:\\Users\\DELL\\Desktop\\node_modules',
     'C:\\Users\\DELL\\node_modules',
     'C:\\Users\\node_modules',
     'C:\\node_modules' ] 
}

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码里的Module对象</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
  <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><table><thead><tr><th>属性</th> <th>描述</th></tr></thead> <tbody><tr><td><code>module.id</code></td> <td>字符串，模块的识别符，通常是带有绝对路径的模块文件名</td></tr> <tr><td><code>module.exports</code></td> <td>对象，模块对外输出的值</td></tr> <tr><td><code>module.parent</code></td> <td>对象，调用该模块的模块</td></tr> <tr><td><code>module.filename</code></td> <td>字符串，模块的绝对路径</td></tr> <tr><td><code>module.loaded</code></td> <td>布尔值，模块是否已经完成加载</td></tr> <tr><td><code>module.children</code></td> <td>数组，该模块要用到的其他模块</td></tr> <tr><td><code>module.paths</code></td> <td>数组，模块可能存在的绝对路径</td></tr></tbody></table> <h4 id="_2-module-prototype-require"><a href="#_2-module-prototype-require" aria-hidden="true" class="header-anchor">#</a> (2)Module.prototype.require</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Loads a module at the given file path. Returns that module's</span>
<span class="token comment">// `exports` property.</span>
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">validateString</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_VALUE</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                                    <span class="token string">'must be a non-empty string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  requireDepth<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">/* isMain */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    requireDepth<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以从代码中看到，<code>require</code>方法主要检查了一下id和它为空的错误处理，然后主要就是调用了<code>Module._load</code>函数。</p> <h4 id="_3-module-load"><a href="#_3-module-load" aria-hidden="true" class="header-anchor">#</a> (3)Module._load</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Check the cache for the requested file.</span>
<span class="token comment">// 1. If a module already exists in the cache: return its exports object.</span>
<span class="token comment">// 2. If the module is native: call</span>
<span class="token comment">//    `NativeModule.prototype.compileForPublicLoader()` and return the exports.</span>
<span class="token comment">// 3. Otherwise, create a new module for the file and save it to the cache.</span>
<span class="token comment">//    Then have it load  the file contents before returning its exports</span>
<span class="token comment">//    object.</span>
<span class="token comment">// 检查请求文件的缓存。</span>
<span class="token comment">// 1. 如果一个模块已经在缓存中存在:返回它的导出对象。</span>
<span class="token comment">// 2. 如果模块是本机的:调用' NativeModule.prototype.compileForPublicLoader() '并返回导出。</span>
<span class="token comment">// 3. 否则，为文件创建一个新模块并将其保存到缓存中。然后让它在返回导出之前加载模块对象。</span>
Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> relResolveCacheIdentifier<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... ...省略部分代码</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用_resolveFilename 拼接出文件的绝对路径</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用_cache查看是否存在缓存，若存在则不需要再次执行，返回缓存即可</span>
  <span class="token keyword">const</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cachedModule<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用loadNativeModule加载Node原生模块  </span>
  <span class="token comment">// 如果Node原生模块有该模块且能被用户引用，返回mod.exports</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">loadNativeModule</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> request<span class="token punctuation">,</span> experimentalModules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mod <span class="token operator">&amp;&amp;</span> mod<span class="token punctuation">.</span>canBeRequiredByUsers<span class="token punctuation">)</span> <span class="token keyword">return</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token comment">// 创建一个模块</span>
  <span class="token comment">// Don't call updateChildren(), Module constructor already does.</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>mainModule <span class="token operator">=</span> module<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将该模块添加到缓存中</span>
  Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span> <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> threw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加载执行新的模块</span>
    module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    threw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> relativeResolveCache<span class="token punctuation">[</span>relResolveCacheIdentifier<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 输出模块的exports属性</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Module._cache</code>就是个对象, <code>Module._cache = Object.create(null);</code></p> <p>所以，根据上面的源码，<code>Module._load</code>的流程:</p> <ol><li>调用_resolveFilename 拼接出文件的绝对路径</li> <li>调用_cache查看是否存在缓存，若存在则不需要再次执行，返回缓存即可</li> <li>调用loadNativeModule加载Node原生模块，如果Node原生模块有该模块且能被用户引用，就返回该模块导出的内容</li> <li>创建一个模块</li> <li>将该模块添加到缓存中</li> <li>调用prototype中的load方法加载执行新的模块</li> <li>输出模块的exports属性</li></ol> <blockquote><p>下面对上述流程中出现的方法调用进行简单的分析：</p></blockquote> <h4 id="_4-module-resolvefilename确定模块的绝对路径"><a href="#_4-module-resolvefilename确定模块的绝对路径" aria-hidden="true" class="header-anchor">#</a> (4)Module._resolveFilename确定模块的绝对路径</h4> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_resolveFilename</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">// 第一步：如果是内置模块，不含路径返回</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>NativeModule<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> request<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 第二步：确定所有可能的路径</span>
 <span class="token keyword">var</span> resolvedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveLookupPaths</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> id <span class="token operator">=</span> resolvedModule<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> paths <span class="token operator">=</span> resolvedModule<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token comment">// 第三步：确定哪一个路径为真</span>
 <span class="token keyword">var</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_findPath</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot find module '&quot;</span> <span class="token operator">+</span> request <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   err<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token string">'MODULE_NOT_FOUND'</span><span class="token punctuation">;</span>
   <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> filename<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到<code>Module._resolveFilename</code>又调用了<code>Module._resolveLookupPaths</code>和<code>Module._findPath</code></p> <h5 id="module-findpath"><a href="#module-findpath" aria-hidden="true" class="header-anchor">#</a> Module._findPath()</h5> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_findPath</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> paths</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">// 列出所有可能的后缀名：.js，.json, .node</span>
 <span class="token keyword">var</span> exts <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 如果是绝对路径，就不再搜索</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 是否有后缀的目录斜杠</span>
 <span class="token keyword">var</span> trailingSlash <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 第一步：如果当前路径已在缓存中，就直接返回缓存</span>
 <span class="token keyword">var</span> cacheKey <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>request<span class="token punctuation">:</span> request<span class="token punctuation">,</span> paths<span class="token punctuation">:</span> paths<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 第二步：依次遍历所有路径</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PL</span> <span class="token operator">=</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">PL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">var</span> filename<span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trailingSlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 第三步：是否存在该模块文件</span>
     filename <span class="token operator">=</span> <span class="token function">tryFile</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>trailingSlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 第四步：该模块文件加上后缀名，是否存在</span>
       filename <span class="token operator">=</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 第五步：目录中是否存在 package.json </span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     filename <span class="token operator">=</span> <span class="token function">tryPackage</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 第六步：是否存在目录名 + index + 后缀名 </span>
     filename <span class="token operator">=</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exts<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 第七步：将找到的文件路径存入返回缓存，然后返回</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     Module<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span> <span class="token operator">=</span> filename<span class="token punctuation">;</span>
     <span class="token keyword">return</span> filename<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 第八步：没有找到文件，返回false </span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><h4 id="_5-module-prototype-load"><a href="#_5-module-prototype-load" aria-hidden="true" class="header-anchor">#</a> (5)Module.prototype.load</h4> <p>上面拥有了模块的绝对路径了，开始加载模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Given a file name, pass it to the proper extension handler.</span>
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> extension <span class="token operator">=</span> <span class="token function">findLongestRegisteredExtension</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不同的扩展名，对应不同的读取方法</span>
  Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面是对应的四种不同模块文件的加载方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Native extension for .js</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Native extension for .json</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.json'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleURL <span class="token operator">=</span> <span class="token function">pathToFileURL</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    manifest<span class="token punctuation">.</span><span class="token function">assertIntegrity</span><span class="token punctuation">(</span>moduleURL<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span>message <span class="token operator">=</span> filename <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Native extension for .node</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.node'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> moduleURL <span class="token operator">=</span> <span class="token function">pathToFileURL</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    manifest<span class="token punctuation">.</span><span class="token function">assertIntegrity</span><span class="token punctuation">(</span>moduleURL<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Be aware this doesn't use `content`</span>
  <span class="token keyword">return</span> process<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">toNamespacedPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.mjs'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_REQUIRE_ESM</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="module-prototype-compile"><a href="#module-prototype-compile" aria-hidden="true" class="header-anchor">#</a> Module.prototype._compile</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result<span class="token punctuation">;</span>
  <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token keyword">const</span> thisValue <span class="token operator">=</span> exports<span class="token punctuation">;</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">compiledWrapper</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisValue<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span>
                                  filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>实际上，上面的代码由于对象调用，this即当前调用的模块，则上面的代码等同于</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模块源码</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-解惑"><a href="#_3-解惑" aria-hidden="true" class="header-anchor">#</a> 3. 解惑</h3> <h4 id="_3-1-从未自己声明过require、export、module变量"><a href="#_3-1-从未自己声明过require、export、module变量" aria-hidden="true" class="header-anchor">#</a> 3.1 从未自己声明过require、export、module变量</h4> <p>从上面的<code>Module.prototype._compile</code>我们可以看出来，模块的实质还是一个函数作用域，就是使用 IIFE 立即调用函数表达式将其包裹了一下，并传入<code>exports, require, module, __filename, __dirname</code>这几个在 Node.js 源码内定义了的变量</p> <p>也就是说，模块的加载实质上就是，注入<code>exports</code>、<code>require</code>、<code>module</code>三个全局变量，然后执行模块的源码，然后将模块的 exports 变量的值输出。</p> <h4 id="_3-2-exports和module-exports的引用是一样的"><a href="#_3-2-exports和module-exports的引用是一样的" aria-hidden="true" class="header-anchor">#</a> 3.2 exports和module.exports的引用是一样的</h4> <p>还是看上面的<code>Module.prototype._compile</code>，我们看到<code>const exports = this.exports; var module = this;</code>，所以，现在，我们总算是明白了为什么既可以使用 <code>exports.xxx = function(){...}</code>也可以使用<code>module.exports={xxx}</code>了，因为他们根本就是一样的。</p> <blockquote><p>虽然我们说Node是CommonJs的实现，但实际上，2013年Node Modules就不再和CommonJS纠缠了。</p> <p>Ryan在2011年也说到过'Consider CommonJS extinct - not worth thinking further about. That was a 2009 thing.'</p> <p>CommonJS想要在尽可能多的操作系统和解释器上工作，但是他对浏览器却很不友好，不支持异步加载。。。</p> <p>而且Node是后端Javascript。Ryan Dahl: &quot;Forget CommonJS. It's dead. We are server side JavaScript.&quot;</p></blockquote> <h2 id="thank"><a href="#thank" aria-hidden="true" class="header-anchor">#</a> THANK</h2> <p><a href="http://wiki.commonjs.org/wiki/Modules" target="_blank" rel="noopener noreferrer">Wiki-Modules<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023027697415616" target="_blank" rel="noopener noreferrer">廖雪峰-NodeJS-模块<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5e174b815188254c075d0d8d" target="_blank" rel="noopener noreferrer">node 的模块运行机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5b8396ae51882542d02ccb89" target="_blank" rel="noopener noreferrer">来来来，探究一下CommonJs的实现原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">6/10/2020, 4:44:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/module-standard/001-module-concept/" class="prev">
          001-前端模块化
        </a></span> <span class="next"><a href="/os/">
          操作系统
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.b1906b97.js" defer></script><script src="/assets/js/2.bdee5faf.js" defer></script><script src="/assets/js/18.ade73665.js" defer></script><script src="/assets/js/7.f0379e88.js" defer></script><script src="/assets/js/8.e132ed9d.js" defer></script>
  </body>
</html>
